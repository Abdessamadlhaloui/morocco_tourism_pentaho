<?xml version="1.0" ?>
<transformation>
  <info>
    <name>09_nuitees_mensuelles</name>
    <description>Transformation for loading 09_nuitees_mensuelles.csv into PostgreSQL</description>
    <extended_description/>
    <trans_version/>
    <trans_type>Normal</trans_type>
    <directory>/</directory>
    <parameters/>
  </info>
  <connection>
    <name>morocco_tourism</name>
    <server>localhost</server>
    <type>POSTGRESQL</type>
    <access>Native</access>
    <database>morocco_tourism</database>
    <port>5432</port>
    <username>postgres</username>
    <password>your_password_here</password>
    <attributes>
      <attribute>
        <code>FORCE_IDENTIFIERS_TO_LOWERCASE</code>
        <attribute>N</attribute>
      </attribute>
    </attributes>
  </connection>
  <step>
    <name>Lire_nuitees_mensuelles</name>
    <type>TextFileInput</type>
    <distribute>Y</distribute>
    <copies>1</copies>
    <GUI>
      <xloc>100</xloc>
      <yloc>100</yloc>
      <draw>Y</draw>
    </GUI>
    <separator>,</separator>
    <enclosure>&quot;</enclosure>
    <header>Y</header>
    <encoding>UTF-8</encoding>
    <file>
      <name>data/raw/09_nuitees_mensuelles.csv</name>
    </file>
    <fields>
      <field>
        <name>Mois</name>
        <type>String</type>
      </field>
      <field>
        <name>Type_Touriste</name>
        <type>String</type>
      </field>
      <field>
        <name>Annee_2019</name>
        <type>String</type>
      </field>
      <field>
        <name>Annee_2021</name>
        <type>String</type>
      </field>
      <field>
        <name>Annee_2022</name>
        <type>String</type>
      </field>
      <field>
        <name>Variation_22_21_pct</name>
        <type>String</type>
      </field>
    </fields>
  </step>
  <step>
    <name>Standardiser_colonnes</name>
    <type>SelectValues</type>
    <distribute>Y</distribute>
    <copies>1</copies>
    <GUI>
      <xloc>320</xloc>
      <yloc>100</yloc>
      <draw>Y</draw>
    </GUI>
    <fields>
      <field>
        <name>Mois</name>
        <rename>mois</rename>
      </field>
      <field>
        <name>Type_Touriste</name>
        <rename>type_touriste</rename>
      </field>
      <field>
        <name>Annee_2019</name>
        <rename>annee_2019</rename>
      </field>
      <field>
        <name>Annee_2021</name>
        <rename>annee_2021</rename>
      </field>
      <field>
        <name>Annee_2022</name>
        <rename>annee_2022</rename>
      </field>
      <field>
        <name>Variation_22_21_pct</name>
        <rename>variation_22_21_pct</rename>
      </field>
    </fields>
  </step>
  <step>
    <name>Mois_vers_numero</name>
    <type>ValueMapper</type>
    <distribute>Y</distribute>
    <copies>1</copies>
    <GUI>
      <xloc>540</xloc>
      <yloc>100</yloc>
      <draw>Y</draw>
    </GUI>
    <field_to_use>mois</field_to_use>
    <target_field_name>mois_num</target_field_name>
    <fields>
      <field>
        <source_value>Janvier</source_value>
        <target_value>1</target_value>
      </field>
      <field>
        <source_value>Février</source_value>
        <target_value>2</target_value>
      </field>
      <field>
        <source_value>Fevrier</source_value>
        <target_value>2</target_value>
      </field>
      <field>
        <source_value>Mars</source_value>
        <target_value>3</target_value>
      </field>
      <field>
        <source_value>Avril</source_value>
        <target_value>4</target_value>
      </field>
      <field>
        <source_value>Mai</source_value>
        <target_value>5</target_value>
      </field>
      <field>
        <source_value>Juin</source_value>
        <target_value>6</target_value>
      </field>
      <field>
        <source_value>Juillet</source_value>
        <target_value>7</target_value>
      </field>
      <field>
        <source_value>Août</source_value>
        <target_value>8</target_value>
      </field>
      <field>
        <source_value>Aout</source_value>
        <target_value>8</target_value>
      </field>
      <field>
        <source_value>Septembre</source_value>
        <target_value>9</target_value>
      </field>
      <field>
        <source_value>Octobre</source_value>
        <target_value>10</target_value>
      </field>
      <field>
        <source_value>Novembre</source_value>
        <target_value>11</target_value>
      </field>
      <field>
        <source_value>Décembre</source_value>
        <target_value>12</target_value>
      </field>
    </fields>
  </step>
  <step>
    <name>Trim_type_touriste</name>
    <type>StringOperations</type>
    <distribute>Y</distribute>
    <copies>1</copies>
    <GUI>
      <xloc>760</xloc>
      <yloc>100</yloc>
      <draw>Y</draw>
    </GUI>
    <fields>
      <field>
        <name>type_touriste</name>
        <trim_type>both</trim_type>
      </field>
    </fields>
  </step>
  <step>
    <name>Unpivot_annees</name>
    <type>RowNormaliser</type>
    <distribute>Y</distribute>
    <copies>1</copies>
    <GUI>
      <xloc>980</xloc>
      <yloc>100</yloc>
      <draw>Y</draw>
    </GUI>
    <fields>
      <field>
        <typefield>annee_2019</typefield>
        <valuefield>nuitees</valuefield>
        <newfield>annee_str</newfield>
      </field>
      <field>
        <typefield>annee_2021</typefield>
        <valuefield>nuitees</valuefield>
        <newfield>annee_str</newfield>
      </field>
      <field>
        <typefield>annee_2022</typefield>
        <valuefield>nuitees</valuefield>
        <newfield>annee_str</newfield>
      </field>
    </fields>
  </step>
  <step>
    <name>Extraire_annee</name>
    <type>ModifiedJavaScriptValue</type>
    <distribute>Y</distribute>
    <copies>1</copies>
    <GUI>
      <xloc>1200</xloc>
      <yloc>100</yloc>
      <draw>Y</draw>
    </GUI>
    <jsScripts>var annee = parseInt(annee_str.replace(/\D/g, ''));</jsScripts>
    <fields>
      <field>
        <name>annee</name>
        <type>Integer</type>
      </field>
    </fields>
  </step>
  <step>
    <name>Nettoyer_nuitees</name>
    <type>ReplaceInString</type>
    <distribute>Y</distribute>
    <copies>1</copies>
    <GUI>
      <xloc>1420</xloc>
      <yloc>100</yloc>
      <draw>Y</draw>
    </GUI>
    <fields>
      <field>
        <in_stream_name>nuitees</in_stream_name>
        <replace_string> </replace_string>
        <replace_by_string/>
      </field>
      <field>
        <in_stream_name>nuitees</in_stream_name>
        <replace_string>,</replace_string>
        <replace_by_string/>
      </field>
    </fields>
  </step>
  <step>
    <name>Convertir_types</name>
    <type>SelectValues</type>
    <distribute>Y</distribute>
    <copies>1</copies>
    <GUI>
      <xloc>1640</xloc>
      <yloc>100</yloc>
      <draw>Y</draw>
    </GUI>
    <fields>
      <field>
        <name>annee</name>
        <type>Integer</type>
        <format>####</format>
        <length>4</length>
        <precision>0</precision>
      </field>
      <field>
        <name>mois_num</name>
        <type>Integer</type>
        <format>#</format>
        <length>2</length>
        <precision>0</precision>
      </field>
      <field>
        <name>nuitees</name>
        <type>Integer</type>
        <format>########</format>
        <length>10</length>
        <precision>0</precision>
      </field>
      <field>
        <name>variation_22_21_pct</name>
        <type>Number</type>
        <format>#.##</format>
        <length>10</length>
        <precision>2</precision>
      </field>
      <field>
        <name>type_touriste</name>
        <type>String</type>
        <format/>
        <length>50</length>
        <precision>-1</precision>
      </field>
    </fields>
  </step>
  <step>
    <name>Filtrer_nulls</name>
    <type>FilterRows</type>
    <distribute>Y</distribute>
    <copies>1</copies>
    <GUI>
      <xloc>1860</xloc>
      <yloc>100</yloc>
      <draw>Y</draw>
    </GUI>
    <send_true_to>Lookup_temps</send_true_to>
    <condition>
      <conditions>
        <condition>
          <leftvalue>annee</leftvalue>
          <function>IS NOT NULL</function>
        </condition>
        <operator>AND</operator>
        <condition>
          <leftvalue>mois_num</leftvalue>
          <function>IS NOT NULL</function>
        </condition>
        <operator>AND</operator>
        <condition>
          <leftvalue>type_touriste</leftvalue>
          <function>IS NOT NULL</function>
        </condition>
        <operator>AND</operator>
        <condition>
          <leftvalue>nuitees</leftvalue>
          <function>IS NOT NULL</function>
        </condition>
        <operator>AND</operator>
        <condition>
          <leftvalue>nuitees</leftvalue>
          <function>&gt;</function>
          <value>
            <text>0</text>
            <type>Number</type>
          </value>
        </condition>
      </conditions>
    </condition>
  </step>
  <step>
    <name>Lookup_temps</name>
    <type>DatabaseLookup</type>
    <distribute>Y</distribute>
    <copies>1</copies>
    <GUI>
      <xloc>2080</xloc>
      <yloc>100</yloc>
      <draw>Y</draw>
    </GUI>
    <connection>morocco_tourism</connection>
    <table>dim_temps</table>
    <keys>
      <key>
        <condition>=</condition>
        <name>annee</name>
        <field>annee</field>
      </key>
      <key>
        <condition>=</condition>
        <name>mois_num</name>
        <field>mois_num</field>
      </key>
    </keys>
    <values>
      <value>
        <name>temps_id</name>
        <rename>temps_id</rename>
      </value>
    </values>
  </step>
  <step>
    <name>Inserer_fact_nuitees</name>
    <type>InsertUpdate</type>
    <distribute>Y</distribute>
    <copies>1</copies>
    <GUI>
      <xloc>2300</xloc>
      <yloc>100</yloc>
      <draw>Y</draw>
    </GUI>
    <connection>morocco_tourism</connection>
    <table>fact_nuitees</table>
    <commit>1000</commit>
    <use_batch>Y</use_batch>
    <lookup>
      <key>
        <name>temps_id</name>
        <field>temps_id</field>
        <condition>=</condition>
      </key>
      <key>
        <name>type_touriste</name>
        <field>type_touriste</field>
        <condition>=</condition>
      </key>
    </lookup>
    <update>
      <update>
        <name>nombre_nuitees</name>
        <field>nuitees</field>
        <update>Y</update>
      </update>
      <update>
        <name>variation_annuelle_pct</name>
        <field>variation_22_21_pct</field>
        <update>Y</update>
      </update>
    </update>
  </step>
  <hop>
    <from>Lire_nuitees_mensuelles</from>
    <to>Standardiser_colonnes</to>
    <enabled>Y</enabled>
  </hop>
  <hop>
    <from>Standardiser_colonnes</from>
    <to>Mois_vers_numero</to>
    <enabled>Y</enabled>
  </hop>
  <hop>
    <from>Mois_vers_numero</from>
    <to>Trim_type_touriste</to>
    <enabled>Y</enabled>
  </hop>
  <hop>
    <from>Trim_type_touriste</from>
    <to>Unpivot_annees</to>
    <enabled>Y</enabled>
  </hop>
  <hop>
    <from>Unpivot_annees</from>
    <to>Extraire_annee</to>
    <enabled>Y</enabled>
  </hop>
  <hop>
    <from>Extraire_annee</from>
    <to>Nettoyer_nuitees</to>
    <enabled>Y</enabled>
  </hop>
  <hop>
    <from>Nettoyer_nuitees</from>
    <to>Convertir_types</to>
    <enabled>Y</enabled>
  </hop>
  <hop>
    <from>Convertir_types</from>
    <to>Filtrer_nulls</to>
    <enabled>Y</enabled>
  </hop>
  <hop>
    <from>Filtrer_nulls</from>
    <to>Lookup_temps</to>
    <enabled>Y</enabled>
  </hop>
  <hop>
    <from>Lookup_temps</from>
    <to>Inserer_fact_nuitees</to>
    <enabled>Y</enabled>
  </hop>
</transformation>
